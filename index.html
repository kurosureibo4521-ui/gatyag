<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガチャシミュレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
        }
        
        .gacha-container {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .prize-card {
            transition: all 0.3s ease;
        }
        
        .prize-card:hover {
            transform: translateY(-5px);
        }
        
        .result-animation {
            animation: popIn 0.5s ease-out forwards;
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            70% {
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .gacha-button {
            transition: all 0.2s ease;
        }
        
        .gacha-button:active {
            transform: scale(0.95);
        }
        
        .rarity-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .notification {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .edit-modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        
        /* アルティメットレア用の輝くエフェクト */
        .ultimate-glow {
            animation: ultimateGlow 2s infinite alternate;
            box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.7);
        }
        
        @keyframes ultimateGlow {
            0% {
                box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.7);
            }
            100% {
                box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.9);
            }
        }
        
        .ultimate-text {
            background: linear-gradient(to right, #f59e0b, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer 2s infinite;
            background-size: 200% 100%;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }
        
        /* エラーメッセージのスタイル */
        .error-message {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* 闇ガチャモード用のスタイル */
        .dark-gacha-mode {
            background: linear-gradient(135deg, #1f2937, #4b5563);
        }

        .dark-gacha-mode .gacha-container {
            background: linear-gradient(135deg, #111827, #374151);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-center text-indigo-800">ガチャシミュレーター</h1>
            <div class="flex items-center space-x-2">
                <label for="dark-mode-toggle" id="dark-mode-text-label" class="text-gray-700">闇ガチャモード</label>
                <input type="checkbox" id="dark-mode-toggle" class="relative w-10 h-5 transition-colors duration-200 ease-in-out bg-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                <div id="dark-mode-label" class="absolute w-4 h-4 transition-transform duration-200 ease-in-out bg-white rounded-full shadow inset-y-0 left-0"></div>
            </div>
        </div>
        
        <div id="notification" class="fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md max-w-md z-50 hidden notification">
            <div class="flex">
                <div class="py-1">
                    <svg class="h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p id="notification-message" class="font-bold">保存しました！</p>
                    <p class="text-sm">変更内容が自動的に保存されました。</p>
                </div>
            </div>
        </div>
        
        <div id="error-notification" class="fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md max-w-md z-50 hidden notification error-message">
            <div class="flex">
                <div class="py-1">
                    <svg class="h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p id="error-message" class="font-bold">エラー</p>
                    <p class="text-sm">対象者を入力してください。</p>
                </div>
            </div>
        </div>
        
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">景品を編集</h3>
                    <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">景品名</label>
                    <input type="text" id="edit-prize-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>
                
                <div class="mb-4" id="edit-rarity-container">
                    <label class="block text-gray-700 mb-2">レア度</label>
                    <select id="edit-rarity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <option value="common">N (59%)</option>
                        <option value="rare">R (30%)</option>
                        <option value="super-rare">SR (8%)</option>
                        <option value="ultra-rare">UR (2%)</option>
                        <option value="ultimate-rare">LR (1%)</option>
                    </select>
                </div>
                
                <div class="mb-4" id="edit-probability-group">
                    <label class="block text-gray-700 mb-2">確率 (%)</label>
                    <input type="number" id="edit-probability" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" step="0.1" min="0.1" max="100">
                </div>
                
                <div class="flex justify-end">
                    <button id="save-edit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">
                        保存
                    </button>
                </div>
                
                <input type="hidden" id="edit-prize-id">
            </div>
        </div>
        
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">ガチャ設定</h3>
                    <button id="close-settings-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">1回あたりの消費ポイント</label>
                    <input type="number" id="point-per-draw" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" min="1" value="100">
                </div>
                
                <div class="flex justify-end">
                    <button id="save-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">
                        保存
                    </button>
                </div>
            </div>
        </div>
        
        <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">結果をシェア</h3>
                    <button id="close-share-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">シェアメッセージ</label>
                    <textarea id="share-message" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400 h-32" readonly></textarea>
                </div>
                
                <div class="flex justify-end">
                    <button id="share-to-x" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Xでシェア
                    </button>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <div class="gacha-container p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">ガチャを回す</h2>
                        <button id="open-settings" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-md font-bold py-2 px-4 text-sm">
                            ポイント設定
                        </button>
                    </div>
                    
                    <div class="bg-white bg-opacity-90 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">対象者:</span>
                            <div class="w-3/4 relative">
                                <input type="text" id="target-person" class="w-full px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="対象者の名前">
                                <div id="target-error" class="text-red-500 text-xs mt-1 hidden">対象者を入力してください</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">回数:</span>
                            <div class="flex items-center">
                                <button id="decrease-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-l-lg hover:bg-gray-300">-</button>
                                <input type="number" id="gacha-count" class="w-16 text-center border-t border-b border-gray-300 py-1" value="1" min="1" max="999">
                                <button id="increase-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-r-lg hover:bg-gray-300">+</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">消費ポイント:</span>
                            <span id="point-cost" class="font-bold text-indigo-700">100 pt</span>
                        </div>
                    </div>
                    
                    <div class="bg-white bg-opacity-90 rounded-lg p-4 mb-4 min-h-[150px] flex items-center justify-center">
                        <div id="result-area" class="text-center w-full">
                            <p class="text-gray-500">ここに結果が表示されます</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="draw-button" class="gacha-button flex-grow bg-yellow-400 hover:bg-yellow-300 text-indigo-900 font-bold py-3 px-4 rounded-lg shadow-lg">
                            ガチャを回す！
                        </button>
                        <button id="share-result" class="gacha-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4">ガチャ履歴</h2>
                    <div id="history-area" class="space-y-3 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">履歴はまだありません</p>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4">景品設定</h2>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">景品名</label>
                        <input type="text" id="prize-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="景品の名前">
                    </div>
                    
                    <div class="mb-4" id="rarity-container">
                        <label class="block text-gray-700 mb-2">レア度</label>
                        <select id="rarity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            <option value="common">N (59%)</option>
                            <option value="rare">R (30%)</option>
                            <option value="super-rare">SR (8%)</option>
                            <option value="ultra-rare">UR (2%)</option>
                            <option value="ultimate-rare">LR (1%)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4 hidden" id="probability-group">
                        <label class="block text-gray-700 mb-2">確率 (%)</label>
                        <input type="number" id="probability" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="確率" step="0.1" min="0.1" max="100">
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="add-prize" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex-grow">
                            追加
                        </button>
                        <button id="clear-prizes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">
                            全削除
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-indigo-800">景品一覧</h2>
                        <span class="text-sm text-gray-600">合計確率: <span id="total-probability">0</span>%</span>
                    </div>
                    
                    <div class="mb-3 flex flex-wrap gap-2" id="rarity-badges-container">
                        <span class="rarity-badge bg-gray-200 text-gray-800">N</span>
                        <span class="rarity-badge bg-blue-200 text-blue-800">R</span>
                        <span class="rarity-badge bg-purple-200 text-purple-800">SR</span>
                        <span class="rarity-badge bg-pink-200 text-pink-800">UR</span>
                        <span class="rarity-badge bg-yellow-200 text-yellow-800 ultimate-text">LR</span>
                    </div>

                    <div class="mb-4">
                        <label for="sort-order" class="block text-gray-700 mb-2">表示順:</label>
                        <select id="sort-order" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            <option value="registration-newest">登録順 (新しいものが上)</option>
                            <option value="registration-oldest">登録順 (古いものが上)</option>
                            <option value="rarity">レア度順</option>
                        </select>
                    </div>
                    
                    <div id="prize-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">景品はまだ登録されていません</p>
                    </div>
                    
                    </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const body = document.body;
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const darkGachaModeLabel = document.getElementById('dark-mode-text-label');
            const prizeNameInput = document.getElementById('prize-name');
            const raritySelect = document.getElementById('rarity');
            const rarityContainer = document.getElementById('rarity-container');
            const probabilityGroup = document.getElementById('probability-group');
            const probabilityInput = document.getElementById('probability');
            const addPrizeButton = document.getElementById('add-prize');
            const clearPrizesButton = document.getElementById('clear-prizes');
            const prizeList = document.getElementById('prize-list');
            const totalProbabilitySpan = document.getElementById('total-probability');
            const drawButton = document.getElementById('draw-button');
            const resultArea = document.getElementById('result-area');
            const historyArea = document.getElementById('history-area');
            const gachaCountInput = document.getElementById('gacha-count');
            const decreaseCountButton = document.getElementById('decrease-count');
            const increaseCountButton = document.getElementById('increase-count');
            const pointCostSpan = document.getElementById('point-cost');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            const errorNotification = document.getElementById('error-notification');
            const errorMessage = document.getElementById('error-message');
            const editModal = document.getElementById('edit-modal');
            const closeEditModalButton = document.getElementById('close-edit-modal');
            const editPrizeNameInput = document.getElementById('edit-prize-name');
            const editRaritySelect = document.getElementById('edit-rarity');
            const editRarityContainer = document.getElementById('edit-rarity-container');
            const editProbabilityGroup = document.getElementById('edit-probability-group');
            const editProbabilityInput = document.getElementById('edit-probability');
            const saveEditButton = document.getElementById('save-edit');
            const editPrizeIdInput = document.getElementById('edit-prize-id');
            const openSettingsButton = document.getElementById('open-settings');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalButton = document.getElementById('close-settings-modal');
            const pointPerDrawInput = document.getElementById('point-per-draw');
            const saveSettingsButton = document.getElementById('save-settings');
            const shareResultButton = document.getElementById('share-result');
            const shareModal = document.getElementById('share-modal');
            const closeShareModalButton = document.getElementById('close-share-modal');
            const shareMessageTextarea = document.getElementById('share-message');
            const shareToXButton = document.getElementById('share-to-x');
            const targetPersonInput = document.getElementById('target-person');
            const targetError = document.getElementById('target-error');
            const sortOrderSelect = document.getElementById('sort-order');
            const rarityBadgesContainer = document.getElementById('rarity-badges-container');
            
            // Data
            let prizes = [];
            let history = [];
            let pointPerDraw = 100;
            let currentResults = null;
            let targetPerson = "";
            let currentSortOrder = 'registration-newest';
            let isDarkGachaMode = false;

            // Default probabilities and colors for each rarity
            const normalRaritySettings = {
                'common': { defaultProb: 59, bgColor: 'bg-gray-200', textColor: 'text-gray-800', label: 'N' },
                'rare': { defaultProb: 30, bgColor: 'bg-blue-200', textColor: 'text-blue-800', label: 'R' },
                'super-rare': { defaultProb: 8, bgColor: 'bg-purple-200', textColor: 'text-purple-800', label: 'SR' },
                'ultra-rare': { defaultProb: 2, bgColor: 'bg-pink-200', textColor: 'text-pink-800', label: 'UR' },
                'ultimate-rare': { defaultProb: 1, bgColor: 'bg-yellow-200', textColor: 'text-yellow-800', label: 'LR', isUltimate: true }
            };

            const darkRaritySettings = {
                'hit': { defaultProb: 0.2, bgColor: 'bg-green-200', textColor: 'text-green-800', label: '当たり', isHit: true },
                'miss': { defaultProb: 99.8, bgColor: 'bg-gray-200', textColor: 'text-gray-800', label: 'ハズレ' }
            };
            
            let raritySettings = normalRaritySettings;
            let rarityPriority = ['ultimate-rare', 'ultra-rare', 'super-rare', 'rare', 'common'];
            
            // Toggle Dark Gacha Mode
            darkModeToggle.addEventListener('change', function() {
                isDarkGachaMode = this.checked;
                if (isDarkGachaMode) {
                    body.classList.add('dark-gacha-mode');
                    darkGachaModeLabel.classList.remove('text-gray-700');
                    darkGachaModeLabel.classList.add('text-white');
                    darkGachaModeLabel.textContent = '通常モード';
                    raritySettings = darkRaritySettings;
                    rarityPriority = ['hit', 'miss'];
                    
                    prizes = [];
                    addDarkGachaPrizes();
                    
                    rarityContainer.classList.add('hidden');
                    editRarityContainer.classList.add('hidden');
                    probabilityGroup.classList.remove('hidden');
                    editProbabilityGroup.classList.remove('hidden');

                    probabilityInput.value = raritySettings['hit'].defaultProb;
                    probabilityInput.readOnly = false;
                    probabilityInput.min = 0.1;
                    probabilityInput.max = 100;
                } else {
                    body.classList.remove('dark-gacha-mode');
                    darkGachaModeLabel.classList.remove('text-white');
                    darkGachaModeLabel.classList.add('text-gray-700');
                    darkGachaModeLabel.textContent = '闇ガチャモード';
                    raritySettings = normalRaritySettings;
                    rarityPriority = ['ultimate-rare', 'ultra-rare', 'super-rare', 'rare', 'common'];

                    prizes = [];
                    
                    rarityContainer.classList.remove('hidden');
                    editRarityContainer.classList.remove('hidden');
                    probabilityGroup.classList.add('hidden');
                    editProbabilityGroup.classList.add('hidden');
                }

                updateRaritySelectOptions();
                updatePrizeList();
                saveToLocalStorage();
            });

            // Add prizes for Dark Gacha Mode
            function addDarkGachaPrizes() {
                prizes.push({
                    name: raritySettings['miss'].label,
                    rarity: 'miss',
                    probability: raritySettings['miss'].defaultProb,
                    registrationOrder: Date.now()
                });
                updatePrizeList();
            }

            // Update rarity select options
            function updateRaritySelectOptions() {
                raritySelect.innerHTML = '';
                editRaritySelect.innerHTML = '';
                rarityBadgesContainer.innerHTML = '';

                if (isDarkGachaMode) {
                    const hitOption = document.createElement('option');
                    hitOption.value = 'hit';
                    hitOption.textContent = '当たり';
                    raritySelect.appendChild(hitOption);

                    const editHitOption = document.createElement('option');
                    editHitOption.value = 'hit';
                    editHitOption.textContent = '当たり';
                    editRaritySelect.appendChild(editHitOption);

                    const editMissOption = document.createElement('option');
                    editMissOption.value = 'miss';
                    editMissOption.textContent = 'ハズレ';
                    editRaritySelect.appendChild(editMissOption);

                    const hitBadge = document.createElement('span');
                    hitBadge.className = 'rarity-badge bg-green-200 text-green-800';
                    hitBadge.textContent = '当たり';
                    rarityBadgesContainer.appendChild(hitBadge);

                    const missBadge = document.createElement('span');
                    missBadge.className = 'rarity-badge bg-gray-200 text-gray-800';
                    missBadge.textContent = 'ハズレ';
                    rarityBadgesContainer.appendChild(missBadge);

                } else {
                    for (const rarity in normalRaritySettings) {
                        const option = document.createElement('option');
                        option.value = rarity;
                        option.textContent = `${normalRaritySettings[rarity].label} (${normalRaritySettings[rarity].defaultProb}%)`;
                        raritySelect.appendChild(option);

                        const editOption = document.createElement('option');
                        editOption.value = rarity;
                        editOption.textContent = `${normalRaritySettings[rarity].label} (${normalRaritySettings[rarity].defaultProb}%)`;
                        editRaritySelect.appendChild(editOption);

                        const badge = document.createElement('span');
                        badge.className = `rarity-badge ${normalRaritySettings[rarity].bgColor} ${normalRaritySettings[rarity].textColor}`;
                        if (normalRaritySettings[rarity].isUltimate) {
                            badge.classList.add('ultimate-text');
                        }
                        badge.textContent = normalRaritySettings[rarity].label;
                        rarityBadgesContainer.appendChild(badge);
                    }
                }
            }

            // Set default probability when rarity is changed
            raritySelect.addEventListener('change', function() {
                const selectedRarity = this.value;
                if(isDarkGachaMode) {
                    probabilityGroup.classList.remove('hidden');
                    if (selectedRarity === 'hit') {
                        probabilityInput.value = raritySettings['hit'].defaultProb;
                        probabilityInput.readOnly = false;
                        probabilityInput.min = 0.1;
                        probabilityInput.max = 100;
                    } else if (selectedRarity === 'miss') {
                        // Miss prize probability is automatically calculated
                        probabilityInput.value = 100 - prizes.filter(p => p.rarity === 'hit').reduce((sum, p) => sum + p.probability, 0);
                        probabilityInput.readOnly = true;
                    }
                } else {
                    probabilityGroup.classList.add('hidden');
                }
            });
            
            // Handle rarity change in edit modal
            editRaritySelect.addEventListener('change', function() {
                const selectedRarity = this.value;
                const id = parseInt(editPrizeIdInput.value);
                const prize = prizes.find(p => p.registrationOrder === id);
                
                if(isDarkGachaMode) {
                    editProbabilityGroup.classList.remove('hidden');
                    if(selectedRarity === 'hit') {
                        editProbabilityInput.readOnly = false;
                        editProbabilityInput.min = 0.1;
                        editProbabilityInput.max = 100;
                    } else if (selectedRarity === 'miss') {
                        editProbabilityInput.readOnly = true;
                    }
                } else {
                    editProbabilityGroup.classList.remove('hidden');
                    const originalRarity = prize.rarity;
                    const newDefaultProb = raritySettings[selectedRarity].defaultProb;
                    const numPrizesInNewRarity = prizes.filter((p, i) => p.registrationOrder !== id && p.rarity === selectedRarity).length + 1;
                    const newProbValue = newDefaultProb / numPrizesInNewRarity;
                    editProbabilityInput.value = Math.round(newProbValue * 10) / 10;
                }
            });

            // Watch for changes in gacha count input
            gachaCountInput.addEventListener('input', function() {
                let value = parseInt(this.value);
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > 999) {
                    this.value = 999;
                }
                updatePointCost();
            });

            // Decrease gacha count
            decreaseCountButton.addEventListener('click', function() {
                let value = parseInt(gachaCountInput.value);
                if (value > 1) {
                    gachaCountInput.value = value - 1;
                    updatePointCost();
                }
            });

            // Increase gacha count
            increaseCountButton.addEventListener('click', function() {
                let value = parseInt(gachaCountInput.value);
                if (value < 999) {
                    gachaCountInput.value = value + 1;
                    updatePointCost();
                }
            });

            // Watch for changes in target person input
            targetPersonInput.addEventListener('input', function() {
                targetError.classList.add('hidden');
                targetPersonInput.classList.remove('border-red-500');
            });
            
            // Set initial values
            updateRaritySelectOptions();
            if(isDarkGachaMode) {
                probabilityInput.value = raritySettings['hit'].defaultProb;
                probabilityInput.readOnly = false;
                probabilityInput.min = 0.1;
                probabilityInput.max = 100;
                probabilityGroup.classList.remove('hidden');
            } else {
                probabilityGroup.classList.add('hidden');
                probabilityInput.value = raritySettings[raritySelect.value].defaultProb;
            }

            // Open settings modal
            openSettingsButton.addEventListener('click', function() {
                pointPerDrawInput.value = pointPerDraw;
                settingsModal.classList.remove('hidden');
            });

            // Close settings modal
            closeSettingsModalButton.addEventListener('click', function() {
                settingsModal.classList.add('hidden');
            });

            // Save settings
            saveSettingsButton.addEventListener('click', function() {
                const newPointPerDraw = parseInt(pointPerDrawInput.value);
                if (isNaN(newPointPerDraw) || newPointPerDraw < 1) {
                    alert('有効なポイント値を入力してください');
                    return;
                }
                pointPerDraw = newPointPerDraw;
                updatePointCost();
                saveToLocalStorage();
                showNotification('設定を保存しました');
                settingsModal.classList.add('hidden');
            });

            // Close share modal
            closeShareModalButton.addEventListener('click', function() {
                shareModal.classList.add('hidden');
            });

            // Share to X
            shareToXButton.addEventListener('click', function() {
                const text = encodeURIComponent(shareMessageTextarea.value);
                window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            });

            // Share results
            shareResultButton.addEventListener('click', function() {
                if (!currentResults) return;
                const shareMessage = createShareMessage(currentResults, targetPerson);
                shareMessageTextarea.value = shareMessage;
                shareModal.classList.remove('hidden');
            });

            // Create share message
            function createShareMessage(results, person) {
                const rarityCount = {};
                for (const rarity in raritySettings) {
                    rarityCount[rarity] = 0;
                }
                const resultCounts = {};
                results.forEach(result => {
                    rarityCount[result.rarity]++;
                    if (!resultCounts[result.name]) {
                        resultCounts[result.name] = { count: 0, rarity: result.rarity, probability: getPrizeProbability(result.name) };
                    }
                    resultCounts[result.name].count++;
                });

                let highestRarity = rarityPriority[rarityPriority.length - 1];
                for (const rarity of rarityPriority) {
                    if (rarityCount[rarity] > 0) {
                        highestRarity = rarity;
                        break;
                    }
                }
                
                const highestRarityPrizes = Object.entries(resultCounts)
                    .filter(([_, data]) => data.rarity === highestRarity)
                    .map(([name, data]) => `${name}(${data.count})`);

                let message = `【ガチャシミュレーター】${results.length}回引いた結果\n#なるみんTOOL\n`;

                if (person) {
                    message += `対象者：${person}\n\n`;
                } else {
                    message += `対象者：\n\n`;
                }

                if (highestRarityPrizes.length > 0) {
                    message += `最高レア度(${raritySettings[highestRarity].label}): ${highestRarityPrizes.join(', ')}\n\n`;
                }

                message += '【獲得した景品一覧】\n';
                
                const sortedItems = Object.entries(resultCounts).sort((a, b) => {
                    return rarityPriority.indexOf(a[1].rarity) - rarityPriority.indexOf(b[1].rarity);
                });

                sortedItems.forEach(([name, data]) => {
                    const rarityLabel = raritySettings[data.rarity].label;
                    const probability = data.probability !== undefined ? `(${data.probability}%)` : '';
                    message += `・${name} (${rarityLabel}${probability}) x${data.count}\n`;
                });

                return message;
            }

            // Get prize probability
            function getPrizeProbability(name) {
                const prize = prizes.find(p => p.name === name);
                return prize ? prize.probability : undefined;
            }

            // Rebalance probabilities for a specific rarity
            function rebalanceRarityProbabilities(rarityToRebalance, excludedPrizeId = null) {
                if (isDarkGachaMode) {
                    updatePrizeList();
                    return;
                }
                const prizesOfRarity = prizes.filter(prize => prize.rarity === rarityToRebalance && prize.registrationOrder !== excludedPrizeId);
                const excludedPrize = excludedPrizeId ? prizes.find(p => p.registrationOrder === excludedPrizeId) : null;
                
                if (prizesOfRarity.length === 0) {
                    if (excludedPrize) {
                        excludedPrize.probability = raritySettings[rarityToRebalance].defaultProb;
                    }
                    return;
                }
                
                const defaultRarityProb = raritySettings[rarityToRebalance].defaultProb;
                let totalProbForRebalance = defaultRarityProb;
                if (excludedPrize) {
                    totalProbForRebalance -= excludedPrize.probability;
                }

                if (totalProbForRebalance < 0) {
                    totalProbForRebalance = 0;
                    showErrorNotification('レアリティの合計確率が100%を超えています。');
                }

                const newProbPerPrize = totalProbForRebalance / prizesOfRarity.length;
                prizesOfRarity.forEach(prize => {
                    prize.probability = Math.round(newProbPerPrize * 10) / 10;
                });
                
                const currentSum = prizesOfRarity.reduce((sum, prize, index) => {
                    if (index < prizesOfRarity.length - 1) {
                        return sum + prize.probability;
                    }
                    return sum;
                }, 0);
                if (prizesOfRarity.length > 0) {
                    prizesOfRarity[prizesOfRarity.length - 1].probability = Math.round((totalProbForRebalance - currentSum) * 10) / 10;
                }
                
                autoAdjustTotalProbability();
                updatePrizeList();
                saveToLocalStorage();
            }

            // Automatically adjust total probability to 100%
            function autoAdjustTotalProbability() {
                if (prizes.length === 0) return;
                if (isDarkGachaMode) {
                    const hitPrizes = prizes.filter(p => p.rarity === 'hit');
                    const missPrize = prizes.find(p => p.rarity === 'miss');
                    if (!missPrize) {
                        showErrorNotification('ハズレ景品が存在しません。');
                        return;
                    }
                    const totalHitProb = hitPrizes.reduce((sum, p) => sum + p.probability, 0);
                    missPrize.probability = Math.round((100 - totalHitProb) * 10) / 10;
                    if (missPrize.probability < 0) {
                        missPrize.probability = 0;
                        showErrorNotification('当たりの合計確率が100%を超えています。');
                    }
                    return;
                }
                const rarityGroupTotals = {};
                for (const rarity in raritySettings) {
                    rarityGroupTotals[rarity] = 0;
                }
                prizes.forEach(prize => {
                    rarityGroupTotals[prize.rarity] += prize.probability;
                });
                let overallTotal = 0;
                for (const rarity in rarityGroupTotals) {
                    overallTotal += rarityGroupTotals[rarity];
                }
                if (Math.abs(overallTotal - 100) > 0.01) {
                    const adjustmentFactor = 100 / overallTotal;
                    prizes.forEach(prize => {
                        prize.probability = Math.round((prize.probability * adjustmentFactor) * 10) / 10;
                    });
                }
                let finalTotal = prizes.reduce((sum, prize) => {
                    return sum + prize.probability;
                }, 0);
                if (prizes.length > 0 && Math.abs(finalTotal - 100) > 0.01) {
                    const diff = 100 - finalTotal;
                    prizes[prizes.length - 1].probability = Math.round((prizes[prizes.length - 1].probability + diff) * 10) / 10;
                }
            }

            // Add a prize
            addPrizeButton.addEventListener('click', function() {
                const name = prizeNameInput.value.trim();
                const rarity = raritySelect.value;
                let probability = isDarkGachaMode ? parseFloat(probabilityInput.value) : raritySettings[rarity].defaultProb;

                if (!name) {
                    showErrorNotification('景品名を入力してください');
                    return;
                }

                if (isDarkGachaMode) {
                    if (rarity === 'hit' && (isNaN(probability) || probability <= 0)) {
                        showErrorNotification('有効な確率を入力してください');
                        return;
                    }
                }

                const existingPrize = prizes.find(p => p.name === name);
                if (existingPrize) {
                    showErrorNotification('同じ景品名は使用できません');
                    return;
                }

                prizes.push({
                    name,
                    rarity,
                    probability,
                    registrationOrder: Date.now()
                });

                if (!isDarkGachaMode) {
                    rebalanceRarityProbabilities(rarity);
                } else {
                    autoAdjustTotalProbability();
                }

                prizeNameInput.value = '';
                updatePrizeList();
                saveToLocalStorage();
                showNotification('景品を追加しました');
            });

            // Clear all prizes
            clearPrizesButton.addEventListener('click', function() {
                if (confirm('全ての景品を削除します。よろしいですか？')) {
                    prizes = [];
                    if (isDarkGachaMode) {
                        addDarkGachaPrizes();
                    }
                    updatePrizeList();
                    saveToLocalStorage();
                    showNotification('全ての景品を削除しました');
                }
            });

            // Draw gacha
            drawButton.addEventListener('click', function() {
                const count = parseInt(gachaCountInput.value);
                targetPerson = targetPersonInput.value.trim();

                if (!targetPerson) {
                    targetError.classList.remove('hidden');
                    targetPersonInput.classList.add('border-red-500');
                    showErrorNotification('対象者を入力してください');
                    return;
                }
                
                targetError.classList.add('hidden');
                targetPersonInput.classList.remove('border-red-500');

                if (prizes.length === 0) {
                    showErrorNotification('景品が登録されていません');
                    return;
                }

                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                if (Math.abs(totalProbability - 100) > 0.1) {
                    showErrorNotification('景品の合計確率が100%になっていません。調整してください。');
                    return;
                }

                resultArea.innerHTML = '';
                resultArea.classList.add('grid', 'grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-4', 'w-full');
                
                const results = [];
                for (let i = 0; i < count; i++) {
                    results.push(drawOne());
                }
                currentResults = results;
                
                displayResults(results);

                shareResultButton.classList.remove('hidden');

                addHistory(targetPerson, count, results);
                updateHistoryList();
                
                // 対象者入力欄をクリアする
                targetPersonInput.value = '';
            });

            function drawOne() {
                const total = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                let random = Math.random() * total;
                for (const prize of prizes) {
                    if (random < prize.probability) {
                        return prize;
                    }
                    random -= prize.probability;
                }
                return prizes[prizes.length - 1];
            }
            
            function displayResults(results) {
                resultArea.innerHTML = '';
                resultArea.classList.add('grid', 'grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-4', 'w-full');
                
                const resultCounts = {};
                results.forEach(result => {
                    if (!resultCounts[result.name]) {
                        resultCounts[result.name] = { count: 0, rarity: result.rarity, probability: result.probability };
                    }
                    resultCounts[result.name].count++;
                });

                // Sort results by rarity priority
                const sortedResults = Object.keys(resultCounts).sort((a, b) => {
                    const rarityA = resultCounts[a].rarity;
                    const rarityB = resultCounts[b].rarity;
                    return rarityPriority.indexOf(rarityA) - rarityPriority.indexOf(rarityB);
                });

                sortedResults.forEach(prizeName => {
                    const result = resultCounts[prizeName];
                    const prizeCard = createPrizeCard(prizeName, result.rarity, result.count, result.probability);
                    resultArea.appendChild(prizeCard);
                });
                
                shareResultButton.classList.remove('hidden');
            }

            // Create prize card for display
            function createPrizeCard(name, rarity, count, probability) {
                const card = document.createElement('div');
                const rarityInfo = raritySettings[rarity];
                let cardClass = `prize-card p-2 rounded-lg text-center shadow-md result-animation`;
                cardClass += ` ${rarityInfo.bgColor} ${rarityInfo.textColor}`;
                if (rarityInfo.isUltimate) {
                    card.classList.add('ultimate-glow');
                }
                card.className = cardClass;
                card.innerHTML = `<span class="font-bold">${name}</span><br><span class="text-xs">${rarityInfo.label} (${probability}%) x${count}</span>`;
                return card;
            }

            // Update point cost display
            function updatePointCost() {
                pointCostSpan.textContent = `${parseInt(gachaCountInput.value) * pointPerDraw} pt`;
            }

            // Show notification
            function showNotification(message) {
                notificationMessage.textContent = message;
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            }

            // Show error notification
            function showErrorNotification(message) {
                errorMessage.textContent = message;
                errorNotification.classList.remove('hidden');
                setTimeout(() => {
                    errorNotification.classList.add('hidden');
                }, 5000);
            }

            // Update prize list
            function updatePrizeList() {
                prizeList.innerHTML = '';
                
                let sortedPrizes = [...prizes];
                if (currentSortOrder === 'rarity') {
                    sortedPrizes.sort((a, b) => {
                        return rarityPriority.indexOf(a.rarity) - rarityPriority.indexOf(b.rarity);
                    });
                } else if (currentSortOrder === 'registration-newest') {
                    sortedPrizes.sort((a, b) => b.registrationOrder - a.registrationOrder);
                } else if (currentSortOrder === 'registration-oldest') {
                    sortedPrizes.sort((a, b) => a.registrationOrder - b.registrationOrder);
                }

                if (sortedPrizes.length === 0) {
                    prizeList.innerHTML = '<p class="text-gray-500 text-center py-4">景品はまだ登録されていません</p>';
                } else {
                    sortedPrizes.forEach((prize) => {
                        const rarityInfo = raritySettings[prize.rarity];
                        const item = document.createElement('div');
                        item.className = 'prize-item flex items-center justify-between bg-gray-100 p-2 rounded-md';
                        
                        const actionButtonsHtml = (isDarkGachaMode && prize.rarity === 'miss') 
                            ? `<button data-id="${prize.registrationOrder}" class="edit-prize text-indigo-600 hover:text-indigo-800 text-sm">編集</button>`
                            : `<button data-id="${prize.registrationOrder}" class="edit-prize text-indigo-600 hover:text-indigo-800 text-sm">編集</button>
                                <button data-id="${prize.registrationOrder}" class="delete-prize text-red-600 hover:text-red-800 text-sm">削除</button>`;

                        const probabilityDisplay = `<span class="text-sm text-gray-600">${prize.probability}%</span>`;

                        item.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <span class="rarity-badge ${rarityInfo.bgColor} ${rarityInfo.textColor} ${rarityInfo.isUltimate ? 'ultimate-text' : ''}">${rarityInfo.label}</span>
                                <span class="text-gray-800">${prize.name}</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                ${probabilityDisplay}
                                <div class="flex space-x-2">
                                    ${actionButtonsHtml}
                                </div>
                            </div>
                        `;
                        prizeList.appendChild(item);
                    });
                }
                
                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                totalProbabilitySpan.textContent = Math.round(totalProbability * 10) / 10;
            }

            // Add history
            function addHistory(person, count, results) {
                history.unshift({
                    person,
                    count,
                    results,
                    timestamp: new Date().toLocaleString()
                });
                if (history.length > 10) {
                    history.pop();
                }
                saveToLocalStorage();
            }

            // Update history list
            function updateHistoryList() {
                historyArea.innerHTML = '';
                if (history.length === 0) {
                    historyArea.innerHTML = '<p class="text-gray-500 text-center py-4">履歴はまだありません</p>';
                } else {
                    history.forEach((entry, index) => {
                        const rarityCount = {};
                        entry.results.forEach(result => {
                            const rarityLabel = raritySettings[result.rarity]?.label || '不明';
                            rarityCount[rarityLabel] = (rarityCount[rarityLabel] || 0) + 1;
                        });
                        const raritySummary = Object.entries(rarityCount).map(([label, count]) => `${label} x${count}`).join(', ');
                        
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item bg-gray-100 p-3 rounded-md shadow-sm';
                        historyItem.innerHTML = `
                            <p class="font-bold text-indigo-800">${entry.person} - ${entry.count}回</p>
                            <p class="text-sm text-gray-600">${entry.timestamp}</p>
                            <p class="text-xs text-gray-500 mt-1">${raritySummary}</p>
                            <div class="mt-2 flex space-x-2">
                                <button data-index="${index}" class="re-display-history bg-indigo-500 text-white text-xs px-2 py-1 rounded hover:bg-indigo-600">再表示</button>
                                <button data-index="${index}" class="re-post-history bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600">再ポスト</button>
                            </div>
                        `;
                        historyArea.appendChild(historyItem);
                    });
                }
            }

            // Handle history actions with event delegation
            historyArea.addEventListener('click', function(e) {
                const targetButton = e.target;
                if (targetButton.classList.contains('re-display-history')) {
                    const index = parseInt(targetButton.dataset.index);
                    const entry = history[index];
                    displayResults(entry.results);
                } else if (targetButton.classList.contains('re-post-history')) {
                    const index = parseInt(targetButton.dataset.index);
                    const entry = history[index];
                    const shareMessage = createShareMessage(entry.results, entry.person);
                    shareMessageTextarea.value = shareMessage;
                    shareModal.classList.remove('hidden');
                }
            });

            // Delete a prize
            prizeList.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-prize')) {
                    const id = parseInt(e.target.dataset.id);
                    const index = prizes.findIndex(p => p.registrationOrder === id);
                    if (index === -1) return;

                    const deletedPrize = prizes[index];
                    if (isDarkGachaMode && deletedPrize.rarity === 'miss') {
                        showErrorNotification('ハズレ景品は削除できません');
                        return;
                    }
                    prizes.splice(index, 1);
                    if (!isDarkGachaMode) {
                        rebalanceRarityProbabilities(deletedPrize.rarity);
                    } else {
                        autoAdjustTotalProbability();
                    }
                    updatePrizeList();
                    saveToLocalStorage();
                    showNotification('景品を削除しました');
                }
            });

            // Edit a prize
            prizeList.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-prize')) {
                    const id = parseInt(e.target.dataset.id);
                    const prize = prizes.find(p => p.registrationOrder === id);
                    if (!prize) return;

                    editPrizeIdInput.value = id;
                    editPrizeNameInput.value = prize.name;
                    editRaritySelect.value = prize.rarity;
                    editProbabilityInput.value = prize.probability;

                    if (isDarkGachaMode && prize.rarity === 'miss') {
                        editPrizeNameInput.disabled = false;
                        editRaritySelect.disabled = true;
                        editProbabilityInput.readOnly = true;
                        editProbabilityGroup.classList.remove('hidden');
                    } else if (!isDarkGachaMode) {
                        editPrizeNameInput.disabled = false;
                        editRaritySelect.disabled = false;
                        editProbabilityGroup.classList.remove('hidden');
                        editProbabilityInput.readOnly = false;
                        editProbabilityInput.min = 0.1;
                        editProbabilityInput.max = 100;
                    } else { // Dark Gacha Mode, but not a "miss" prize
                        editPrizeNameInput.disabled = false;
                        editRaritySelect.disabled = false;
                        editProbabilityGroup.classList.remove('hidden');
                        editProbabilityInput.readOnly = false;
                        editProbabilityInput.min = 0.1;
                        editProbabilityInput.max = 100;
                    }
                    editModal.classList.remove('hidden');
                }
            });

            // Close edit modal
            closeEditModalButton.addEventListener('click', function() {
                editPrizeNameInput.disabled = false;
                editRaritySelect.disabled = false;
                editModal.classList.add('hidden');
            });

            // Save edited prize
            saveEditButton.addEventListener('click', function() {
                const id = parseInt(editPrizeIdInput.value);
                const index = prizes.findIndex(p => p.registrationOrder === id);
                if (index === -1) return;
                
                const prizeToEdit = prizes[index];

                const name = editPrizeNameInput.value.trim();
                const rarity = editRaritySelect.value;
                const probability = parseFloat(editProbabilityInput.value);

                if (!name) {
                    showErrorNotification('景品名を入力してください');
                    return;
                }

                const existingPrize = prizes.find((p, i) => p.registrationOrder !== id && p.name === name);
                if (existingPrize) {
                    showErrorNotification('同じ景品名は使用できません');
                    return;
                }

                if(isNaN(probability) || probability <= 0 || probability > 100) {
                    showErrorNotification('有効な確率を入力してください');
                    return;
                }

                const oldRarity = prizes[index].rarity;
                prizes[index].name = name;
                prizes[index].rarity = rarity;
                prizes[index].probability = probability;

                if (!isDarkGachaMode) {
                    const totalForRarity = prizes.filter(p => p.rarity === rarity).reduce((sum, p) => sum + p.probability, 0);
                    if (totalForRarity > raritySettings[rarity].defaultProb) {
                        showErrorNotification(`${raritySettings[rarity].label}の合計確率が${raritySettings[rarity].defaultProb}%を超えています。手動で調整してください。`);
                    }
                    if (oldRarity !== rarity) {
                        rebalanceRarityProbabilities(oldRarity);
                    }
                } else {
                    autoAdjustTotalProbability();
                }
                
                updatePrizeList();
                saveToLocalStorage();
                showNotification('景品を編集しました');
                editModal.classList.add('hidden');
            });

            // Sort prizes
            sortOrderSelect.addEventListener('change', function() {
                currentSortOrder = this.value;
                updatePrizeList();
            });

            // Save to Local Storage
            function saveToLocalStorage() {
                localStorage.setItem('gacha-simulator-prizes', JSON.stringify(prizes));
                localStorage.setItem('gacha-simulator-history', JSON.stringify(history));
                localStorage.setItem('gacha-simulator-point-per-draw', pointPerDraw);
                localStorage.setItem('gacha-simulator-is-dark-gacha-mode', isDarkGachaMode);
            }

            // Load from Local Storage
            function loadFromLocalStorage() {
                const savedPrizes = localStorage.getItem('gacha-simulator-prizes');
                if (savedPrizes) {
                    prizes = JSON.parse(savedPrizes);
                }

                const savedHistory = localStorage.getItem('gacha-simulator-history');
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                }

                const savedPointPerDraw = localStorage.getItem('gacha-simulator-point-per-draw');
                if (savedPointPerDraw) {
                    pointPerDraw = parseInt(savedPointPerDraw);
                }

                const savedDarkGachaMode = localStorage.getItem('gacha-simulator-is-dark-gacha-mode');
                if (savedDarkGachaMode) {
                    isDarkGachaMode = savedDarkGachaMode === 'true';
                    darkModeToggle.checked = isDarkGachaMode;
                    if (isDarkGachaMode) {
                        body.classList.add('dark-gacha-mode');
                        darkGachaModeLabel.classList.remove('text-gray-700');
                        darkGachaModeLabel.classList.add('text-white');
                        darkGachaModeLabel.textContent = '通常モード';
                        raritySettings = darkRaritySettings;
                        rarityPriority = ['hit', 'miss'];
                        rarityContainer.classList.add('hidden');
                        editRarityContainer.classList.add('hidden');
                        probabilityGroup.classList.remove('hidden');
                        editProbabilityGroup.classList.remove('hidden');
                    } else {
                        body.classList.remove('dark-gacha-mode');
                        darkGachaModeLabel.classList.remove('text-white');
                        darkGachaModeLabel.classList.add('text-gray-700');
                        darkGachaModeLabel.textContent = '闇ガチャモード';
                        raritySettings = normalRaritySettings;
                        rarityPriority = ['ultimate-rare', 'ultra-rare', 'super-rare', 'rare', 'common'];
                        rarityContainer.classList.remove('hidden');
                        editRarityContainer.classList.remove('hidden');
                        probabilityGroup.classList.add('hidden');
                        editProbabilityGroup.classList.add('hidden');
                    }
                }
            }

            loadFromLocalStorage();
            updateRaritySelectOptions();
            updatePrizeList();
            updateHistoryList();
            updatePointCost();
        });
    </script>
</body>
</html>
