<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガチャシミュレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
        }
        
        .gacha-container {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .prize-card {
            transition: all 0.3s ease;
        }
        
        .prize-card:hover {
            transform: translateY(-5px);
        }
        
        .result-animation {
            animation: popIn 0.5s ease-out forwards;
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            70% {
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .gacha-button {
            transition: all 0.2s ease;
        }
        
        .gacha-button:active {
            transform: scale(0.95);
        }
        
        .rarity-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .notification {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .edit-modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        
        /* アルティメットレア用の輝くエフェクト */
        .ultimate-glow {
            animation: ultimateGlow 2s infinite alternate;
            box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.7);
        }
        
        @keyframes ultimateGlow {
            0% {
                box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.7);
            }
            100% {
                box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.9);
            }
        }
        
        .ultimate-text {
            background: linear-gradient(to right, #f59e0b, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer 2s infinite;
            background-size: 200% 100%;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }
        
        /* エラーメッセージのスタイル */
        .error-message {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-indigo-800 mb-6">ガチャシミュレーター</h1>
        
        <div id="notification" class="fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md max-w-md z-50 hidden notification">
            <div class="flex">
                <div class="py-1">
                    <svg class="h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p id="notification-message" class="font-bold">保存しました！</p>
                    <p class="text-sm">変更内容が自動的に保存されました。</p>
                </div>
            </div>
        </div>
        
        <div id="error-notification" class="fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md max-w-md z-50 hidden notification error-message">
            <div class="flex">
                <div class="py-1">
                    <svg class="h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p id="error-message" class="font-bold">エラー</p>
                    <p class="text-sm">対象者を入力してください。</p>
                </div>
            </div>
        </div>
        
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">景品を編集</h3>
                    <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">景品名</label>
                    <input type="text" id="edit-prize-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">レア度</label>
                    <select id="edit-rarity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <option value="common">N (59%)</option>
                        <option value="rare">R (30%)</option>
                        <option value="super-rare">SR (8%)</option>
                        <option value="ultra-rare">UR (2%)</option>
                        <option value="ultimate-rare">LR (1%)</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">確率 (%)</label>
                    <input type="number" id="edit-probability" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" step="0.1" min="0.1" max="100">
                </div>
                
                <div class="flex justify-end">
                    <button id="save-edit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">
                        保存
                    </button>
                </div>
                
                <input type="hidden" id="edit-prize-index">
            </div>
        </div>
        
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">ガチャ設定</h3>
                    <button id="close-settings-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">1回あたりの消費ポイント</label>
                    <input type="number" id="point-per-draw" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" min="1" value="100">
                </div>
                
                <div class="flex justify-end">
                    <button id="save-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">
                        保存
                    </button>
                </div>
            </div>
        </div>
        
        <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden edit-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-800">結果をシェア</h3>
                    <button id="close-share-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">シェアメッセージ</label>
                    <textarea id="share-message" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400 h-32" readonly></textarea>
                </div>
                
                <div class="flex justify-end">
                    <button id="share-to-x" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Xでシェア
                    </button>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-3">ガチャグループ</h2>
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                        <select id="gacha-group-select" class="flex-grow sm:w-auto w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"></select>
                        <button id="add-gacha-group" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md w-full sm:w-auto">新規追加</button>
                        <button id="rename-gacha-group" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md w-full sm:w-auto">名前変更</button>
                        <button id="delete-gacha-group" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md w-full sm:w-auto">削除</button>
                    </div>
                </div>

                <div class="gacha-container p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">ガチャを回す</h2>
                        <button id="open-settings" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-2 px-4 rounded-lg">ポイント設定</button>
                    </div>
                    
                    <div class="bg-white bg-opacity-90 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">対象者:</span>
                            <div class="w-3/4 relative">
                                <input type="text" id="target-person" class="w-full px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="対象者の名前">
                                <div id="target-error" class="text-red-500 text-xs mt-1 hidden">対象者を入力してください</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">回数:</span>
                            <div class="flex items-center">
                                <button id="decrease-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-l-lg hover:bg-gray-300">-</button>
                                <input type="number" id="gacha-count" class="w-16 text-center border-t border-b border-gray-300 py-1" value="1" min="1" max="100">
                                <button id="increase-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-r-lg hover:bg-gray-300">+</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">消費ポイント:</span>
                            <span id="point-cost" class="font-bold text-indigo-700">100 pt</span>
                        </div>
                    </div>
                    
                    <div class="bg-white bg-opacity-90 rounded-lg p-4 mb-4 min-h-[150px] flex items-center justify-center">
                        <div id="result-area" class="text-center w-full">
                            <p class="text-gray-500">ここに結果が表示されます</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="draw-button" class="gacha-button flex-grow bg-yellow-400 hover:bg-yellow-300 text-indigo-900 font-bold py-3 px-4 rounded-lg shadow-lg">
                            ガチャを回す！
                        </button>
                        <button id="share-result" class="gacha-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4">ガチャ履歴</h2>
                    <div id="history-area" class="space-y-3 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">履歴はまだありません</p>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4">景品設定</h2>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">景品名</label>
                        <input type="text" id="prize-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="景品の名前">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">レア度</label>
                        <select id="rarity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            <option value="common">N (59%)</option>
                            <option value="rare">R (30%)</option>
                            <option value="super-rare">SR (8%)</option>
                            <option value="ultra-rare">UR (2%)</option>
                            <option value="ultimate-rare">LR (1%)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">確率 (%)</label>
                        <input type="number" id="probability" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="確率" step="0.1" min="0.1" max="100" readonly> </div>
                    
                    <div class="flex space-x-2">
                        <button id="add-prize" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex-grow">
                            追加
                        </button>
                        <button id="clear-prizes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">
                            全削除
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-indigo-800">景品一覧</h2>
                        <span class="text-sm text-gray-600">合計確率: <span id="total-probability">0</span>%</span>
                    </div>
                    
                    <div class="mb-3 flex flex-wrap gap-2">
                        <span class="rarity-badge bg-gray-200 text-gray-800">N</span>
                        <span class="rarity-badge bg-blue-200 text-blue-800">R</span>
                        <span class="rarity-badge bg-purple-200 text-purple-800">SR</span>
                        <span class="rarity-badge bg-pink-200 text-pink-800">UR</span>
                        <span class="rarity-badge bg-yellow-200 text-yellow-800 ultimate-text">LR</span>
                    </div>

                    <div class="mb-4">
                        <label for="sort-order" class="block text-gray-700 mb-2">表示順:</label>
                        <select id="sort-order" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            <option value="registration-newest">登録順 (新しいものが上)</option>
                            <option value="registration-oldest">登録順 (古いものが上)</option>
                            <option value="rarity">レア度順</option>
                        </select>
                    </div>
                    
                    <div id="prize-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">景品はまだ登録されていません</p>
                    </div>
                    
                    </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM要素
            const prizeNameInput = document.getElementById('prize-name');
            const raritySelect = document.getElementById('rarity');
            const probabilityInput = document.getElementById('probability');
            const addPrizeButton = document.getElementById('add-prize');
            const clearPrizesButton = document.getElementById('clear-prizes');
            const prizeList = document.getElementById('prize-list');
            const totalProbabilitySpan = document.getElementById('total-probability');
            const drawButton = document.getElementById('draw-button');
            const resultArea = document.getElementById('result-area');
            const historyArea = document.getElementById('history-area');
            const gachaCountInput = document.getElementById('gacha-count');
            const decreaseCountButton = document.getElementById('decrease-count');
            const increaseCountButton = document.getElementById('increase-count');
            const pointCostSpan = document.getElementById('point-cost');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            const errorNotification = document.getElementById('error-notification');
            const errorMessage = document.getElementById('error-message');
            const editModal = document.getElementById('edit-modal');
            const closeEditModalButton = document.getElementById('close-edit-modal');
            const editPrizeNameInput = document.getElementById('edit-prize-name');
            const editRaritySelect = document.getElementById('edit-rarity');
            const editProbabilityInput = document.getElementById('edit-probability');
            const saveEditButton = document.getElementById('save-edit');
            const editPrizeIndexInput = document.getElementById('edit-prize-index');
            const openSettingsButton = document.getElementById('open-settings');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalButton = document.getElementById('close-settings-modal');
            const pointPerDrawInput = document.getElementById('point-per-draw');
            const saveSettingsButton = document.getElementById('save-settings');
            const shareResultButton = document.getElementById('share-result');
            const shareModal = document.getElementById('share-modal');
            const closeShareModalButton = document.getElementById('close-share-modal');
            const shareMessageTextarea = document.getElementById('share-message');
            const shareToXButton = document.getElementById('share-to-x');
            const targetPersonInput = document.getElementById('target-person');
            const targetError = document.getElementById('target-error');
            const sortOrderSelect = document.getElementById('sort-order');

            // 新しいDOM要素
            const gachaGroupSelect = document.getElementById('gacha-group-select');
            const addGachaGroupButton = document.getElementById('add-gacha-group');
            const renameGachaGroupButton = document.getElementById('rename-gacha-group');
            const deleteGachaGroupButton = document.getElementById('delete-gacha-group');
            
            // データ
            let gachaGroups = {}; // 全てのガチャグループを格納
            let currentGachaId = ''; // 現在選択されているガチャグループのID
            let currentResults = null; // 現在の結果を保存
            
            // 以下、現在のガチャグループのデータにアクセスするためのProxy
            let prizes = [];
            let history = [];
            let pointPerDraw = 100;
            let currentSortOrder = 'registration-newest';
            let targetPerson = ""; // 対象者

            // レア度ごとのデフォルト確率と色
            const raritySettings = {
                'common': { defaultProb: 59, bgColor: 'bg-gray-200', textColor: 'text-gray-800', label: 'N' },
                'rare': { defaultProb: 30, bgColor: 'bg-blue-200', textColor: 'text-blue-800', label: 'R' },
                'super-rare': { defaultProb: 8, bgColor: 'bg-purple-200', textColor: 'text-purple-800', label: 'SR' },
                'ultra-rare': { defaultProb: 2, bgColor: 'bg-pink-200', textColor: 'text-pink-800', label: 'UR' },
                'ultimate-rare': { defaultProb: 1, bgColor: 'bg-yellow-200', textColor: 'text-yellow-800', label: 'LR', isUltimate: true }
            };
            
            // レア度の優先順位（高いものが先）
            const rarityPriority = ['ultimate-rare', 'ultra-rare', 'super-rare', 'rare', 'common'];
            
            // --- ガチャグループ管理機能 ---
            
            // 新しいガチャグループを作成
            addGachaGroupButton.addEventListener('click', function() {
                const groupName = prompt('新しいガチャグループの名前を入力してください:', `ガチャ${Object.keys(gachaGroups).length + 1}`);
                if (groupName && groupName.trim() !== '') {
                    const newId = `gacha_${Date.now()}`;
                    gachaGroups[newId] = {
                        name: groupName.trim(),
                        prizes: [],
                        history: [],
                        pointPerDraw: 100,
                        currentSortOrder: 'registration-newest'
                    };
                    currentGachaId = newId;
                    updateGachaGroupSelect();
                    loadCurrentGachaData();
                    saveToLocalStorage();
                    showNotification(`「${groupName.trim()}」を作成しました！`);
                }
            });

            // ガチャグループの名前を変更
            renameGachaGroupButton.addEventListener('click', function() {
                if (!currentGachaId || !gachaGroups[currentGachaId]) {
                    showErrorNotification('変更するガチャグループがありません。');
                    return;
                }
                const currentName = gachaGroups[currentGachaId].name;
                const newName = prompt(`「${currentName}」の新しい名前を入力してください:`, currentName);
                if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                    gachaGroups[currentGachaId].name = newName.trim();
                    updateGachaGroupSelect();
                    saveToLocalStorage();
                    showNotification(`「${currentName}」を「${newName.trim()}」に名前変更しました！`);
                }
            });

            // ガチャグループを削除
            deleteGachaGroupButton.addEventListener('click', function() {
                const groupIds = Object.keys(gachaGroups);
                if (groupIds.length === 0) {
                    showErrorNotification('削除するガチャグループがありません。');
                    return;
                }
                if (groupIds.length === 1 && groupIds[0] === currentGachaId) {
                    showErrorNotification('最後のガチャグループは削除できません。');
                    return;
                }

                if (confirm(`現在選択中のガチャグループ「${gachaGroups[currentGachaId].name}」を削除しますか？\nこの操作は元に戻せません。`)) {
                    const deletedName = gachaGroups[currentGachaId].name;
                    delete gachaGroups[currentGachaId];

                    // 次に選択するグループを決定
                    if (groupIds.length > 1) { // 削除後もグループが残る場合
                        const remainingIds = Object.keys(gachaGroups);
                        currentGachaId = remainingIds[0]; // 最初のグループを選択
                    } else {
                        // 全てのグループが削除された場合 (これは上記のガードで防がれるはずだが念のため)
                        currentGachaId = '';
                    }

                    updateGachaGroupSelect();
                    loadCurrentGachaData();
                    saveToLocalStorage();
                    showNotification(`「${deletedName}」を削除しました。`);
                }
            });

            // ガチャグループ選択の変更
            gachaGroupSelect.addEventListener('change', function() {
                currentGachaId = this.value;
                loadCurrentGachaData();
                saveToLocalStorage();
            });

            // ガチャグループ選択ドロップダウンを更新
            function updateGachaGroupSelect() {
                gachaGroupSelect.innerHTML = '';
                if (Object.keys(gachaGroups).length === 0) {
                    gachaGroupSelect.innerHTML = '<option value="">グループなし</option>';
                    gachaGroupSelect.disabled = true; // グループがない場合は無効化
                    renameGachaGroupButton.disabled = true;
                    deleteGachaGroupButton.disabled = true;
                    return;
                }
                gachaGroupSelect.disabled = false;
                renameGachaGroupButton.disabled = false;
                deleteGachaGroupButton.disabled = false;

                for (const id in gachaGroups) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = gachaGroups[id].name;
                    gachaGroupSelect.appendChild(option);
                }
                gachaGroupSelect.value = currentGachaId;
            }

            // 現在のガチャグループのデータをロードしてUIに反映
            function loadCurrentGachaData() {
                if (!currentGachaId || !gachaGroups[currentGachaId]) {
                    // グループがない場合の初期化
                    prizes = [];
                    history = [];
                    pointPerDraw = 100;
                    currentSortOrder = 'registration-newest';
                    targetPersonInput.value = ''; // 対象者をクリア
                    resultArea.innerHTML = '<p class="text-gray-500">ここに結果が表示されます</p>';
                    shareResultButton.classList.add('hidden'); // シェアボタンを非表示
                    updatePrizeList();
                    updateHistory();
                    updatePointCost();
                    sortOrderSelect.value = currentSortOrder;
                    return;
                }

                const currentGroup = gachaGroups[currentGachaId];
                prizes = currentGroup.prizes;
                history = currentGroup.history;
                pointPerDraw = currentGroup.pointPerDraw;
                currentSortOrder = currentGroup.currentSortOrder;

                // UI要素を更新
                updatePrizeList();
                updateHistory();
                updatePointCost();
                sortOrderSelect.value = currentSortOrder; // ドロップダウンの選択を反映
                targetPersonInput.value = ''; // 新しいガチャグループを選択した際に以前の対象者をクリア
                resultArea.innerHTML = '<p class="text-gray-500">ここに結果が表示されます</p>'; // 結果表示エリアをリセット
                shareResultButton.classList.add('hidden'); // シェアボタンを非表示
            }
            
            // レア度が変更されたときにデフォルト確率を設定
            raritySelect.addEventListener('change', function() {
                const selectedRarity = this.value;
                const defaultProb = raritySettings[selectedRarity].defaultProb;
                probabilityInput.value = defaultProb;
            });
            
            // 編集モーダルでのレア度変更時も同様に、そのレア度内の確率を均等に設定し直す
            editRaritySelect.addEventListener('change', function() {
                const selectedRarity = this.value;
                const index = parseInt(editPrizeIndexInput.value);
                // const originalRarity = prizes[index].rarity; // 編集前のレア度

                // まず、現在の入力値から新しいレア度のデフォルト確率を取得
                const newDefaultProb = raritySettings[selectedRarity].defaultProb;
                
                // 同じレア度内の景品の数を取得 (編集中の景品も含む)
                const numPrizesInNewRarity = prizes.filter((p, i) => i !== index && p.rarity === selectedRarity).length + 1;
                
                // そのレア度内の景品が1つならそのレア度のデフォルト確率、複数なら均等割り振り
                const newProbValue = numPrizesInNewRarity > 0 ? (newDefaultProb / numPrizesInNewRarity) : newDefaultProb;
                editProbabilityInput.value = Math.round(newProbValue * 10) / 10;
            });
            
            // 対象者の入力を監視
            targetPersonInput.addEventListener('input', function() {
                // エラー表示を消す
                targetError.classList.add('hidden');
                targetPersonInput.classList.remove('border-red-500');
            });
            
            // 初期値を設定
            probabilityInput.value = raritySettings[raritySelect.value].defaultProb;
            
            // 設定モーダルを開く
            openSettingsButton.addEventListener('click', function() {
                pointPerDrawInput.value = pointPerDraw;
                settingsModal.classList.remove('hidden');
            });
            
            // 設定モーダルを閉じる
            closeSettingsModalButton.addEventListener('click', function() {
                settingsModal.classList.add('hidden');
            });
            
            // 設定を保存
            saveSettingsButton.addEventListener('click', function() {
                const newPointPerDraw = parseInt(pointPerDrawInput.value);
                if (isNaN(newPointPerDraw) || newPointPerDraw < 1) {
                    alert('有効なポイント値を入力してください');
                    return;
                }
                
                pointPerDraw = newPointPerDraw;
                gachaGroups[currentGachaId].pointPerDraw = newPointPerDraw; // 現在のグループに保存
                updatePointCost();
                
                // ローカルストレージに保存
                saveToLocalStorage();
                
                // 通知を表示
                showNotification('設定を保存しました');
                
                // モーダルを閉じる
                settingsModal.classList.add('hidden');
            });
            
            // シェアモーダルを閉じる
            closeShareModalButton.addEventListener('click', function() {
                shareModal.classList.add('hidden');
            });
            
            // Xでシェア
            shareToXButton.addEventListener('click', function() {
                const text = encodeURIComponent(shareMessageTextarea.value);
                window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            });
            
            // 結果をシェア
            shareResultButton.addEventListener('click', function() {
                if (!currentResults) return;
                
                const shareMessage = createShareMessage(currentResults);
                shareMessageTextarea.value = shareMessage;
                shareModal.classList.remove('hidden');
            });
            
            // シェアメッセージを作成
            function createShareMessage(results) {
                // レア度ごとの集計
                const rarityCount = {
                    'common': 0,
                    'rare': 0,
                    'super-rare': 0,
                    'ultra-rare': 0,
                    'ultimate-rare': 0
                };
                
                const resultCounts = {};
                
                results.forEach(result => {
                    rarityCount[result.rarity]++;
                    
                    if (!resultCounts[result.name]) {
                        resultCounts[result.name] = {
                            count: 0,
                            rarity: result.rarity,
                            probability: getPrizeProbability(result.name)
                        };
                    }
                    resultCounts[result.name].count++;
                });
                
                // 最高レア度の景品を見つける
                let highestRarity = 'common';
                for (const rarity of rarityPriority) {
                    if (rarityCount[rarity] > 0) {
                        highestRarity = rarity;
                        break;
                    }
                }
                
                // 最高レア度の景品リスト
                const highestRarityPrizes = Object.entries(resultCounts)
                    .filter(([_, data]) => data.rarity === highestRarity)
                    .map(([name, data]) => `${name}(${data.count})`);
                
                // シェアメッセージを構築
                let message = `【ガチャシミュレーター】${results.length}回引いた結果\n#なるみんTOOL\n`;
                
                // 対象者を追加
                // shareResultButtonが押されたときにcurrentResultsに紐づくtargetPersonを使用
                const shareTargetPerson = gachaGroups[currentGachaId].history.find(h => h.results === results)?.targetPerson || targetPerson;

                if (shareTargetPerson) {
                    message += `対象者：${shareTargetPerson}\n\n`;
                } else {
                    message += `対象者：\n\n`;
                }
                
                if (highestRarityPrizes.length > 0) {
                    message += `最高レア度(${raritySettings[highestRarity].label}): ${highestRarityPrizes.join(', ')}\n\n`;
                }
                
                // 獲得した景品の一覧を追加
                message += '【獲得した景品一覧】\n';
                
                // レア度順にソート
                const sortedItems = Object.entries(resultCounts).sort((a, b) => {
                    return rarityPriority.indexOf(a[1].rarity) - rarityPriority.indexOf(b[1].rarity);
                });
                
                sortedItems.forEach(([name, data]) => {
                    const rarityLabel = raritySettings[data.rarity].label;
                    const probability = data.probability !== undefined ? `(${data.probability}%)` : '';
                    message += `・${name} (${rarityLabel}${probability}) x${data.count}\n`;
                });
                
                return message;
            }
            
            // 景品の確率を取得する関数
            function getPrizeProbability(name) {
                const prize = prizes.find(p => p.name === name); // 現在のグループのprizesから検索
                return prize ? prize.probability : undefined;
            }
            
            // 特定のレア度の景品確率を均等に再配分する関数
            function rebalanceRarityProbabilities(rarityToRebalance) {
                const prizesOfRarity = prizes.filter(prize => prize.rarity === rarityToRebalance);
                if (prizesOfRarity.length === 0) {
                    // そのレア度の景品がない場合は何もしない
                    return;
                }

                // そのレア度のデフォルト確率を取得
                const defaultRarityProb = raritySettings[rarityToRebalance].defaultProb;

                // 各景品に均等に割り振る
                const newProbPerPrize = defaultRarityProb / prizesOfRarity.length;

                prizesOfRarity.forEach(prize => {
                    prize.probability = Math.round(newProbPerPrize * 10) / 10; // 小数点第1位まで丸める
                });
                
                // 合計がデフォルト確率になるように最後の景品を微調整
                const currentSum = prizesOfRarity.reduce((sum, prize, index) => {
                    if (index < prizesOfRarity.length - 1) {
                        return sum + prize.probability;
                    }
                    return sum;
                }, 0);

                if (prizesOfRarity.length > 0) {
                    prizesOfRarity[prizesOfRarity.length - 1].probability = Math.round((defaultRarityProb - currentSum) * 10) / 10;
                }

                // 全レア度の合計確率を100%に再調整（最終調整）
                autoAdjustTotalProbability();

                updatePrizeList();
                saveToLocalStorage();
            }

            // 全レア度の合計確率を100%に自動調整する関数
            function autoAdjustTotalProbability() {
                if (prizes.length === 0) return;

                // 各レア度グループの合計確率を一旦計算
                const rarityGroupTotals = {};
                for (const rarity in raritySettings) {
                    rarityGroupTotals[rarity] = 0;
                }
                prizes.forEach(prize => {
                    rarityGroupTotals[prize.rarity] += prize.probability;
                });

                let overallTotal = 0;
                for (const rarity in rarityGroupTotals) {
                    overallTotal += rarityGroupTotals[rarity];
                }

                // 全体の合計が100%からずれている場合に調整
                if (Math.abs(overallTotal - 100) > 0.01) { // 誤差を考慮
                    // 各レア度グループの確率を全体に占める割合に応じて調整
                    const adjustmentFactor = 100 / overallTotal;
                    prizes.forEach(prize => {
                        prize.probability = Math.round((prize.probability * adjustmentFactor) * 10) / 10;
                    });
                }

                // 最後の景品の確率を微調整して合計を正確に100%にする
                let finalTotal = prizes.reduce((sum, prize, index) => {
                    return sum + prize.probability;
                }, 0);
                
                if (prizes.length > 0 && Math.abs(finalTotal - 100) > 0.01) {
                    const diff = 100 - finalTotal;
                    prizes[prizes.length - 1].probability = Math.round((prizes[prizes.length - 1].probability + diff) * 10) / 10;
                }
            }
            
            // 景品を追加
            addPrizeButton.addEventListener('click', function() {
                if (!currentGachaId) {
                    showErrorNotification('ガチャグループを選択または作成してください。');
                    return;
                }
                const name = prizeNameInput.value.trim();
                const rarity = raritySelect.value;

                if (!name) {
                    alert('景品名を入力してください');
                    return;
                }
                
                // 景品を追加（確率は後でrebalanceRarityProbabilitiesで設定される）
                prizes.push({
                    name,
                    rarity,
                    probability: 0, // 初期確率は0にして、後で再調整
                    registrationOrder: Date.now() // 登録順を保存 (タイムスタンプでユニークな順序を保証)
                });
                
                // 入力フィールドをリセット
                prizeNameInput.value = '';
                probabilityInput.value = raritySettings[raritySelect.value].defaultProb; // デフォルト確率に戻す
                
                // 同じレア度の景品を再調整し、全体の合計も調整
                rebalanceRarityProbabilities(rarity);
                
                // 通知を表示
                showNotification('景品を追加しました');
            });
            
            // 景品リストを更新
            function updatePrizeList() {
                if (prizes.length === 0) {
                    prizeList.innerHTML = '<p class="text-gray-500 text-center py-4">景品はまだ登録されていません</p>';
                } else {
                    prizeList.innerHTML = '';
                    
                    // ソート処理
                    let sortedPrizes = [...prizes]; // 元の配列を破壊しないようにコピー
                    if (currentSortOrder === 'rarity') {
                        sortedPrizes.sort((a, b) => {
                            // レア度が高いものほど前になるようにソート
                            return rarityPriority.indexOf(a.rarity) - rarityPriority.indexOf(b.rarity);
                        });
                    } else if (currentSortOrder === 'registration-newest') {
                        // 登録順 (新しいものが上)
                        sortedPrizes.sort((a, b) => b.registrationOrder - a.registrationOrder);
                    } else if (currentSortOrder === 'registration-oldest') {
                        // 登録順 (古いものが上)
                        sortedPrizes.sort((a, b) => a.registrationOrder - b.registrationOrder);
                    }


                    sortedPrizes.forEach((prize, index) => {
                        const rarityStyle = raritySettings[prize.rarity];
                        
                        const prizeElement = document.createElement('div');
                        let className = `prize-card ${rarityStyle.bgColor} ${rarityStyle.textColor} p-3 rounded-lg flex justify-between items-center`;
                        
                        // アルティメットレアの場合は輝くエフェクトを追加
                        if (rarityStyle.isUltimate) {
                            className += ' ultimate-glow';
                        }
                        
                        prizeElement.className = className;
                        
                        let nameDisplay = prize.name;
                        if (rarityStyle.isUltimate) {
                            nameDisplay = `<span class="ultimate-text font-bold">${prize.name}</span>`;
                        }
                        
                        prizeElement.innerHTML = `
                            <div>
                                <div class="font-medium">${nameDisplay}</div>
                                <div class="text-xs">${rarityStyle.label} • ${prize.probability}%</div>
                            </div>
                            <div class="flex space-x-1">
                                <button class="edit-prize text-indigo-500 hover:text-indigo-700" data-original-index="${prizes.indexOf(prize)}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button class="delete-prize text-red-500 hover:text-red-700" data-original-index="${prizes.indexOf(prize)}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        prizeList.appendChild(prizeElement);
                    });
                    
                    // 削除ボタンにイベントリスナーを追加
                    document.querySelectorAll('.delete-prize').forEach(button => {
                        button.addEventListener('click', function() {
                            const originalIndex = parseInt(this.getAttribute('data-original-index'));
                            const deletedRarity = prizes[originalIndex].rarity; // 削除される景品のレア度を保存
                            prizes.splice(originalIndex, 1);
                            
                            // 景品が残っている場合は同じレア度の景品を再調整
                            if (prizes.filter(p => p.rarity === deletedRarity).length > 0) {
                                rebalanceRarityProbabilities(deletedRarity);
                            } else {
                                // そのレア度の景品がなくなった場合でも全体の再調整は必要
                                autoAdjustTotalProbability();
                                updatePrizeList(); 
                            }
                            
                            // ローカルストレージに保存
                            saveToLocalStorage();

                            // 通知を表示
                            showNotification('景品を削除しました');
                        });
                    });
                    
                    // 編集ボタンにイベントリスナーを追加
                    document.querySelectorAll('.edit-prize').forEach(button => {
                        button.addEventListener('click', function() {
                            const originalIndex = parseInt(this.getAttribute('data-original-index'));
                            openEditModal(originalIndex);
                        });
                    });
                }
                
                updateTotalProbability();
                gachaGroups[currentGachaId].prizes = prizes; // 更新されたprizesを現在のグループに保存
                saveToLocalStorage(); // ソート順が変わったことも保存
            }
            
            // 合計確率を更新
            function updateTotalProbability() {
                const total = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                totalProbabilitySpan.textContent = total.toFixed(1);
                
                if (Math.abs(total - 100) < 0.1) {
                    totalProbabilitySpan.className = 'font-bold text-green-600';
                } else {
                    totalProbabilitySpan.className = 'font-bold text-red-600';
                }
            }
            
            // 全景品を削除
            clearPrizesButton.addEventListener('click', function() {
                if (!currentGachaId) {
                    showErrorNotification('ガチャグループを選択または作成してください。');
                    return;
                }
                if (prizes.length === 0) return;
                
                if (confirm('すべての景品を削除しますか？')) {
                    prizes = [];
                    gachaGroups[currentGachaId].prizes = prizes; // 現在のグループのprizesをクリア
                    updatePrizeList();
                    
                    // ローカルストレージに保存
                    saveToLocalStorage();
                    
                    // 通知を表示
                    showNotification('すべての景品を削除しました');
                }
            });
            
            // 編集モーダルを開く
            function openEditModal(index) {
                const prize = prizes[index];
                
                editPrizeNameInput.value = prize.name;
                editRaritySelect.value = prize.rarity;
                editProbabilityInput.value = prize.probability; // 現在の確率を表示
                editPrizeIndexInput.value = index;
                
                editModal.classList.remove('hidden');
            }
            
            // 編集モーダルを閉じる
            closeEditModalButton.addEventListener('click', function() {
                editModal.classList.add('hidden');
            });
            
            // 編集内容を保存
            saveEditButton.addEventListener('click', function() {
                const index = parseInt(editPrizeIndexInput.value);
                const originalRarity = prizes[index].rarity; // 編集前のレア度を保存
                
                const name = editPrizeNameInput.value.trim();
                const rarity = editRaritySelect.value;
                // const probability = parseFloat(editProbabilityInput.value); // ここで入力された確率は一旦無視し、rebalanceで計算し直す

                if (!name) {
                    alert('景品名を入力してください');
                    return;
                }
                
                // 景品を更新（確率は後でrebalanceRarityProbabilitiesで設定される）
                prizes[index] = {
                    ...prizes[index], // registrationOrderを保持
                    name,
                    rarity,
                    probability: 0 // 仮に0に設定し、再調整で正しい値が入るようにする
                };
                
                // レア度が変更された場合は、元のレア度と新しいレア度両方を再調整
                if (originalRarity !== rarity) {
                    if (prizes.filter(p => p.rarity === originalRarity).length > 0) {
                        rebalanceRarityProbabilities(originalRarity);
                    } else {
                        autoAdjustTotalProbability(); 
                    }
                    rebalanceRarityProbabilities(rarity);
                } else {
                    // 同じレア度の場合は、そのレア度のみ再調整
                    rebalanceRarityProbabilities(rarity);
                }
                
                gachaGroups[currentGachaId].prizes = prizes; // 更新されたprizesを現在のグループに保存
                saveToLocalStorage();
                // 通知を表示
                showNotification('景品を更新しました');
                
                // モーダルを閉じる
                editModal.classList.add('hidden');
            });
            
            // エラー通知を表示
            function showErrorNotification(message) {
                errorMessage.textContent = message;
                errorNotification.classList.remove('hidden');
                
                setTimeout(() => {
                    errorNotification.classList.add('hidden');
                }, 3000);
            }
            
            // ガチャを引く
            drawButton.addEventListener('click', function() {
                if (!currentGachaId) {
                    showErrorNotification('ガチャグループを選択または作成してください。');
                    return;
                }
                if (prizes.length === 0) {
                    alert('景品を登録してください');
                    return;
                }
                
                const count = parseInt(gachaCountInput.value);
                if (isNaN(count) || count < 1) {
                    alert('有効な回数を入力してください');
                    return;
                }
                
                // 対象者の入力チェック
                const inputTargetPerson = targetPersonInput.value.trim();
                if (!inputTargetPerson) {
                    // エラー表示
                    targetError.classList.remove('hidden');
                    targetPersonInput.classList.add('border-red-500');
                    showErrorNotification('対象者を入力してください');
                    return;
                }
                
                // 対象者を保存（今回の抽選にのみ使用）
                targetPerson = inputTargetPerson;
                
                const results = [];
                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                
                if (Math.abs(totalProbability - 100) > 0.1) {
                    console.warn('景品合計確率が100%ではありません。自動調整してください。', totalProbability);
                }

                for (let i = 0; i < count; i++) {
                    const rand = Math.random() * totalProbability;
                    let cumulativeProbability = 0;
                    let selectedPrize = null;
                    
                    for (const prize of prizes) {
                        cumulativeProbability += prize.probability;
                        if (rand <= cumulativeProbability) {
                            selectedPrize = prize;
                            break;
                        }
                    }
                    
                    if (selectedPrize) {
                        results.push({
                            name: selectedPrize.name,
                            rarity: selectedPrize.rarity,
                            probability: selectedPrize.probability
                        });
                    } else {
                        console.error("景品が選択されませんでした。確率設定を確認してください。", { rand, cumulativeProbability, prizes });
                        if (prizes.length > 0) {
                            results.push({
                                name: prizes[Math.floor(Math.random() * prizes.length)].name,
                                rarity: prizes[Math.floor(Math.random() * prizes.length)].rarity,
                                probability: 0
                            });
                        }
                    }
                }
                
                currentResults = results;
                
                displayResults(results);
                
                shareResultButton.classList.remove('hidden');
                
                // 履歴に追加 (対象者を含める)
                const historyItem = {
                    timestamp: new Date(),
                    count: count,
                    results: results,
                    pointCost: count * pointPerDraw,
                    targetPerson: targetPerson // 対象者を履歴に保存
                };
                
                history.unshift(historyItem);
                if (history.length > 10) history.pop(); // 最大10件まで保存
                
                gachaGroups[currentGachaId].history = history; // 現在のグループのhistoryを更新
                updateHistory();
                
                saveToLocalStorage();
                
                targetPersonInput.value = ''; // 対象者の入力欄をクリア
            });
            
            // 結果を表示
            function displayResults(results) {
                resultArea.innerHTML = '';
                
                if (results.length === 1) {
                    const result = results[0];
                    const rarityStyle = raritySettings[result.rarity];
                    
                    const resultElement = document.createElement('div');
                    let className = `result-animation ${rarityStyle.bgColor} ${rarityStyle.textColor} p-4 rounded-lg text-center`;
                    
                    if (rarityStyle.isUltimate) {
                        className += ' ultimate-glow';
                    }
                    
                    resultElement.className = className;
                    
                    let nameDisplay = result.name;
                    let labelDisplay = `${rarityStyle.label} (${result.probability}%)`;
                    
                    if (rarityStyle.isUltimate) {
                        nameDisplay = `<span class="ultimate-text text-2xl font-bold">${result.name}</span>`;
                        labelDisplay = `<span class="ultimate-text">${rarityStyle.label} (${result.probability}%)</span>`;
                    }
                    
                    resultElement.innerHTML = `
                        <div class="text-sm mb-1">${labelDisplay}</div>
                        <div class="text-2xl font-bold mb-1">${nameDisplay}</div>
                        <div class="text-sm">おめでとうございます！</div>
                    `;
                    
                    resultArea.appendChild(resultElement);
                } else {
                    const resultCounts = {};
                    const rarityCount = {
                        'common': 0,
                        'rare': 0,
                        'super-rare': 0,
                        'ultra-rare': 0,
                        'ultimate-rare': 0
                    };
                    
                    results.forEach(result => {
                        if (!resultCounts[result.name]) {
                            resultCounts[result.name] = {
                                count: 0,
                                rarity: result.rarity,
                                probability: result.probability
                            };
                        }
                        resultCounts[result.name].count++;
                        rarityCount[result.rarity]++;
                    });
                    
                    const resultElement = document.createElement('div');
                    resultElement.className = 'result-animation';
                    
                    // レア度ごとの集計
                    let rarityHTML = '<div class="mb-3 flex flex-wrap gap-1 justify-center">';
                    if (rarityCount['ultimate-rare'] > 0) {
                        rarityHTML += `<span class="rarity-badge bg-yellow-200 text-yellow-800 ultimate-text">LR x${rarityCount['ultimate-rare']}</span> `;
                    }
                    if (rarityCount['ultra-rare'] > 0) {
                        rarityHTML += `<span class="rarity-badge bg-pink-200 text-pink-800">UR x${rarityCount['ultra-rare']}</span> `;
                    }
                    if (rarityCount['super-rare'] > 0) {
                        rarityHTML += `<span class="rarity-badge bg-purple-200 text-purple-800">SR x${rarityCount['super-rare']}</span> `;
                    }
                    if (rarityCount['rare'] > 0) {
                        rarityHTML += `<span class="rarity-badge bg-blue-200 text-blue-800">R x${rarityCount['rare']}</span> `;
                    }
                    if (rarityCount['common'] > 0) {
                        rarityHTML += `<span class="rarity-badge bg-gray-200 text-gray-800">N x${rarityCount['common']}</span> `;
                    }
                    rarityHTML += '</div>';
                    
                    // 獲得した景品の一覧
                    let itemsHTML = '<div class="grid grid-cols-2 gap-2">';
                    
                    // レア度順にソート
                    const sortedItems = Object.entries(resultCounts).sort((a, b) => {
                        return rarityPriority.indexOf(a[1].rarity) - rarityPriority.indexOf(b[1].rarity);
                    });
                    
                    sortedItems.forEach(([name, data]) => {
                        const rarityStyle = raritySettings[data.rarity];
                        let className = `${rarityStyle.bgColor} ${rarityStyle.textColor} p-2 rounded text-center`;
                        let nameDisplay = name;
                        let labelDisplay = `${rarityStyle.label} (${data.probability}%)`;
                        
                        if (rarityStyle.isUltimate) {
                            className += ' ultimate-glow';
                            nameDisplay = `<span class="ultimate-text font-medium">${name}</span>`;
                            labelDisplay = `<span class="ultimate-text">${rarityStyle.label} (${data.probability}%)</span>`;
                        }
                        
                        itemsHTML += `
                            <div class="${className}">
                                <div class="text-xs">${labelDisplay}</div>
                                <div class="font-medium truncate" title="${name}">${nameDisplay}</div>
                                <div class="text-xs">x${data.count}</div>
                            </div>
                        `;
                    });
                    itemsHTML += '</div>';
                    
                    resultElement.innerHTML = `
                        <div class="text-center mb-2">
                            <div class="text-lg font-bold">${results.length}回ガチャ結果</div>
                        </div>
                        ${rarityHTML}
                        ${itemsHTML}
                    `;
                    
                    resultArea.appendChild(resultElement);
                }
            }
            
            // 履歴を更新
            function updateHistory() {
                if (history.length === 0) {
                    historyArea.innerHTML = '<p class="text-gray-500 text-center py-4">履歴はまだありません</p>';
                    return;
                }
                
                historyArea.innerHTML = '';
                
                history.forEach((item, historyIndex) => {
                    const historyElement = document.createElement('div');
                    historyElement.className = 'bg-gray-50 p-3 rounded-lg';
                    
                    // 日時をフォーマット
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    // レア度ごとの集計
                    const rarityCount = {
                        'common': 0,
                        'rare': 0,
                        'super-rare': 0,
                        'ultra-rare': 0,
                        'ultimate-rare': 0
                    };
                    
                    item.results.forEach(result => {
                        rarityCount[result.rarity]++;
                    });
                    
                    // レア度バッジを作成
                    let rarityBadges = '';
                    if (rarityCount['ultimate-rare'] > 0) {
                        rarityBadges += `<span class="rarity-badge bg-yellow-200 text-yellow-800 ultimate-text">LR x${rarityCount['ultimate-rare']}</span> `;
                    }
                    if (rarityCount['ultra-rare'] > 0) {
                        rarityBadges += `<span class="rarity-badge bg-pink-200 text-pink-800">UR x${rarityCount['ultra-rare']}</span> `;
                    }
                    if (rarityCount['super-rare'] > 0) {
                        rarityBadges += `<span class="rarity-badge bg-purple-200 text-purple-800">SR x${rarityCount['super-rare']}</span> `;
                    }
                    if (rarityCount['rare'] > 0) {
                        rarityBadges += `<span class="rarity-badge bg-blue-200 text-blue-800">R x${rarityCount['rare']}</span> `;
                    }
                    if (rarityCount['common'] > 0) {
                        rarityBadges += `<span class="rarity-badge bg-gray-200 text-gray-800">N x${rarityCount['common']}</span> `;
                    }
                    
                    // 消費ポイントを表示
                    const pointCost = item.pointCost || (item.count * pointPerDraw);
                    
                    // 対象者を表示（あれば）
                    const targetPersonDisplay = item.targetPerson ? `<div class="text-xs text-gray-600">対象者: ${item.targetPerson}</div>` : '';
                    
                    historyElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">${item.count}回ガチャ (${pointCost} pt)</div>
                                <div class="text-xs text-gray-500">${formattedDate}</div>
                                ${targetPersonDisplay}
                            </div>
                            <div class="flex space-x-1">
                                <button class="replay-button bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs" data-history-index="${historyIndex}">
                                    再表示
                                </button>
                                <button class="share-history-button bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs" data-history-index="${historyIndex}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${rarityBadges}
                        </div>
                    `;
                    
                    historyArea.appendChild(historyElement);
                    
                    // 再表示ボタンにイベントリスナーを追加
                    const replayButton = historyElement.querySelector('.replay-button');
                    replayButton.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-history-index'));
                        currentResults = history[index].results;
                        displayResults(history[index].results);
                        shareResultButton.classList.remove('hidden');
                        
                        // 対象者も復元（入力欄には表示しない）
                        targetPerson = history[index].targetPerson || "";
                    });
                    
                    // シェアボタンにイベントリスナーを追加
                    const shareHistoryButton = historyElement.querySelector('.share-history-button');
                    shareHistoryButton.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-history-index'));
                        
                        // 対象者を一時的に設定
                        const originalTargetPerson = targetPerson;
                        targetPerson = history[index].targetPerson || "";
                        
                        const shareMessage = createShareMessage(history[index].results);
                        
                        // 元の対象者に戻す
                        targetPerson = originalTargetPerson;
                        
                        shareMessageTextarea.value = shareMessage;
                        shareModal.classList.remove('hidden');
                    });
                });
            }
            
            // ガチャ回数の増減
            decreaseCountButton.addEventListener('click', function() {
                let count = parseInt(gachaCountInput.value);
                if (count > 1) {
                    gachaCountInput.value = count - 1;
                    updatePointCost();
                }
            });
            
            increaseCountButton.addEventListener('click', function() {
                let count = parseInt(gachaCountInput.value);
                if (count < 100) {
                    gachaCountInput.value = count + 1;
                    updatePointCost();
                }
            });
            
            gachaCountInput.addEventListener('input', function() {
                let count = parseInt(this.value);
                if (isNaN(count) || count < 1) {
                    this.value = 1;
                } else if (count > 100) {
                    this.value = 100;
                }
                updatePointCost();
            });
            
            // ポイントコストを更新
            function updatePointCost() {
                const count = parseInt(gachaCountInput.value);
                const cost = count * pointPerDraw;
                pointCostSpan.textContent = `${cost} pt`;
            }
            
            // 通知を表示
            function showNotification(message) {
                notificationMessage.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            }
            
            // ローカルストレージに保存
            function saveToLocalStorage() {
                const dataToSave = {
                    gachaGroups: gachaGroups,
                    currentGachaId: currentGachaId
                };
                
                localStorage.setItem('gachaSimulatorV2', JSON.stringify(dataToSave)); // バージョン2として保存キーを変更
            }
            
            // ローカルストレージから読み込み
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem('gachaSimulatorV2'); // 新しいキーで読み込み
                if (savedData) {
                    const data = JSON.parse(savedData);
                    gachaGroups = data.gachaGroups || {};
                    currentGachaId = data.currentGachaId || '';

                    // 履歴の日時を文字列からDateオブジェクトに変換
                    for (const id in gachaGroups) {
                        if (gachaGroups[id].history) {
                            gachaGroups[id].history = gachaGroups[id].history.map(item => ({
                                ...item,
                                timestamp: new Date(item.timestamp)
                            }));
                        }
                    }
                } else {
                    // データがない場合、デフォルトのガチャグループを作成
                    const defaultId = 'gacha_default';
                    gachaGroups[defaultId] = {
                        name: 'My Gacha 1',
                        prizes: [],
                        history: [],
                        pointPerDraw: 100,
                        currentSortOrder: 'registration-newest'
                    };
                    currentGachaId = defaultId;
                }
                updateGachaGroupSelect();
                loadCurrentGachaData(); // 現在のグループのデータをロード
            }

            // ソート選択の変更イベントリスナー
            sortOrderSelect.addEventListener('change', function() {
                currentSortOrder = this.value;
                gachaGroups[currentGachaId].currentSortOrder = currentSortOrder; // 現在のグループにソート順を保存
                updatePrizeList(); // ソート順が変わったらリストを再描画
                saveToLocalStorage(); // 変更を保存
            });
            
            // 初期化時にローカルストレージから読み込み
            loadFromLocalStorage();
        });
    </script>
</body>
</html>
